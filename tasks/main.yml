---
- name: Install Nextcloud
  become: true
  tags: install
  block:

    - name: Create nextcloud_net network
      community.docker.docker_network:
        name: nextcloud_net

    - name: Create mariadb_config volume
      docker_volume:
        driver: "local"
        driver_options:
          type: nfs
          o: "addr={{ nas }},nolock,soft,rw"
          device: "{{ mariadb_nfs }}"
        volume_name: mariadb_config

    - name: Create Mariadb container
      community.docker.docker_container:
        name: mariadb
        image: lscr.io/linuxserver/mariadb:latest
        networks:
          - name: nextcloud_net
        pull: true
        restart_policy: unless-stopped
        volumes:
          - mariadb_config:/config
        env:
          TZ: Asia/Bangkok
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          MYSQL_ROOT_PASSWORD: "mariadbpassword"
          MYSQL_DATABASE: "nextcloud"
          MYSQL_USER: "ncuser"
          MYSQL_PASSWORD: "ncpassword"

    - name: Create nextcloud_config volume
      docker_volume:
        driver: "local"
        driver_options:
          type: nfs
          o: "addr={{ nas }},nolock,soft,rw"
          device: "{{ nextcloud_config_nfs }}"
        volume_name: nextcloud_config

    - name: Create nextcloud_data volume
      docker_volume:
        driver: "local"
        driver_options:
          type: nfs
          o: "addr={{ nas }},nolock,soft,rw"
          device: "{{ nextcloud_data_nfs }}"
        volume_name: nextcloud_data

    - name: Create Nextcloud container
      community.docker.docker_container:
        name: nextcloud
        image: lscr.io/linuxserver/nextcloud:latest
        networks:
          - name: nextcloud_net
        pull: true
        restart_policy: unless-stopped
        volumes:
          - nextcloud_config:/config
          - nextcloud_data:/data
        ports:
          - 443:443
        env:
          TZ: Asia/Bangkok
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          UMASK: "022"

    - name: Allow HTTPS
      community.general.ufw:
        rule: allow
        proto: tcp
        port: '443'
      notify: reload ufw
